pipeline {
    agent any

    stages {
        stage('git checkout') {
            steps {
                git 'https://github.com/tkibnyusuf/java-project.git'
            }
        }
        stage('build') {
            steps {
                sh 'cd MywebApp && mvn clean package'
            }
        }
        stage('test') {
            steps {
                sh 'cd MywebApp && mvn test'
            }
        }
         stage('code Quality scan') {
          steps {
          withSonarQubeEnv('sonar') {
        sh "mvn -f MywebApp/pom.xml sonar:sonar"
           }
          }
        }
        stage("Quality gate") {
            steps {
                timeout(time: 30, unit: 'SECONDS') {
            waitForQualityGate abortPipeline: true
            }
        } 
        }
         stage('Server'){
            steps {
                
                rtServer (

                    id: "Artifactory",

                    url: 'http://18.212.224.24.8082/artifactory', 
                    bypassProxy: true,
                    credentialsId: 'ee7e64a7-3de0-4661-b9ce-edc1a5805cb2',
                    timeout: 300
                )
            }
        }
        stage('Upload'){
            steps {
                     rtUpload (
            serverId:"Artifactory" , 
             spec: '''{ 
                     "files": [
                      {
                     "pattern": "*.war", 
                     "target": "logic-ops-lab-libs-snapshot-local"
                      }
                      ]
                    }''',
                )       
              
            }
        }
        
        stage ('Publish build info') {
            steps {
                rtPublishBuildInfo (
                    serverId: "Artifactory"
                    )
                    }
                }
        
        
        stage('deploy to tomcat') {
            steps {
                deploy adapters: [tomcat9(credentialsId: 'tomcat', path: '', url: 'http://54.86.121.142:8080/')], contextPath: 'webapp', war: '**/*.war'
            }    
        }    
    }
}   
